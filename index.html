<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GEOMETRY DREVD: OPTIMIZED</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@900&family=VT323&display=swap');

        body {
            margin: 0;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            color: white;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            user-select: none;
            /* touch-action: none; - –£–±—Ä–∞–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –±—Ä–∞—É–∑–µ—Ä–∞–º–∏, –µ—Å–ª–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–±—Å–æ–ª—é—Ç–Ω–æ –≤–µ–∑–¥–µ */
        }

        #game-wrapper {
            position: relative;
            aspect-ratio: 16/9;
            width: 100%;
            max-height: 100vh;
            max-width: 177.78vh;
            background: #000;
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.2);
            border: 2px solid #333;
        }

        canvas { 
            display: block; 
            width: 100%; 
            height: 100%;
            image-rendering: pixelated;
        }

        /* UI */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0, 0, 0, 0.92); z-index: 20;
            backdrop-filter: blur(4px); transition: opacity 0.2s;
        }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        h1 {
            font-family: 'Orbitron', sans-serif; font-size: 8cqh; margin-bottom: 20px; color: #fff;
            text-shadow: 0 0 10px #00ff00, 0 0 30px #005500; text-align: center;
        }

        .stats-bar { display: flex; gap: 20px; font-family: 'Orbitron'; font-size: 24px; color: #ffd700; margin-bottom: 20px; text-shadow: 0 0 5px #ffd700; }
        #death-msg { color: #ff3333; text-shadow: 0 0 20px #ff0000; font-size: 60px; margin-bottom: 20px; }

        button {
            border: 1px solid #555; padding: 10px 20px; font-size: 16px; font-weight: bold; color: #eee;
            cursor: pointer; border-radius: 5px; text-transform: uppercase; margin: 5px; transition: 0.1s;
            font-family: 'Orbitron', sans-serif; background: #222;
        }
        button:active { transform: scale(0.95); }
        .btn-garage { background: linear-gradient(45deg, #11998e, #38ef7d); border:none; color:#fff; }
        .btn-achieve { background: linear-gradient(45deg, #ff9966, #ff5e62); border:none; color:#fff; }
        .btn-slot { width: 250px; text-align: left; display: flex; justify-content: space-between; align-items: center; }

        .btn-secret { position: absolute; bottom: 15px; right: 15px; background: transparent; border: 1px solid #444; color: #555; font-size: 24px; padding: 5px 12px; z-index: 100; }
        .btn-secret:hover { color: red; border-color: red; }
        
        #btn-auth { 
            position: absolute; top: 15px; left: 15px; 
            background: transparent; border: 1px solid #00e5ff; color: #00e5ff; 
            font-size: 14px; padding: 8px 15px; z-index: 100; 
        }

        #btn-fullscreen {
            position: absolute; top: 15px; right: 15px;
            background: transparent; border: 1px solid #fff; color: #fff;
            font-size: 20px; padding: 5px 10px; z-index: 100;
        }

        /* Lists & Grids */
        .level-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 85%; max-width: 600px; max-height: 250px; overflow-y: auto; margin-bottom: 10px; padding-right: 5px; }
        .level-card { background: #1a1a1a; padding: 15px; border: 1px solid #444; cursor: pointer; display: flex; flex-direction: column; border-radius: 6px; }
        .level-card:hover { background: #252525; border-color: #ffd700; }
        .lvl-header { display: flex; justify-content: space-between; font-weight: bold; }
        .lvl-sub { font-size: 12px; color: #888; margin-top: 5px; display: flex; justify-content: space-between; }

        .garage-container { display: flex; flex-direction: column; gap: 10px; background: rgba(20,20,20,0.95); padding: 20px; border-radius: 10px; border: 1px solid #444; }
        .selection-row { display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap; }
        .color-btn { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid #444; margin: 2px; }
        .color-btn.active { border-color: #fff; box-shadow: 0 0 10px #fff; }
        .skin-btn { width: 50px; height: 50px; border: 2px solid #444; background: #111; cursor: pointer; position: relative; display: flex; justify-content: center; align-items: center; }
        .skin-btn.active { border-color: #0f0; box-shadow: 0 0 10px #0f0; }
        .skin-btn.locked { opacity: 0.5; cursor: not-allowed; }
        .skin-btn.locked::after { content: 'üîí'; position: absolute; font-size: 20px; }

        .pass-input { background: #111; border: 1px solid #0f0; color: #0f0; font-family: 'VT323'; font-size: 26px; text-align: center; padding: 5px; width: 200px; }

        #editor-ui { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: center; flex-wrap:wrap; gap: 5px; pointer-events: none; }
        #editor-ui button { pointer-events: auto; padding: 5px 12px; background: #fff; color: #000; border: none; font-size:18px; border-radius:4px; }
        .info { pointer-events: auto; background: rgba(0,0,0,0.8); padding: 5px; color: #aaa; border-radius: 4px; font-size: 12px; margin-top:5px; width:100%; text-align:center;}
        
        #mobile-play-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; touch-action: none; }
        /* –í–∞–∂–Ω–æ: —ç—Ç–∏ –∫–Ω–æ–ø–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã, –ø–æ—ç—Ç–æ–º—É –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏, –≥–¥–µ tap –≤—ã–∑—ã–≤–∞–µ—Ç –ø—Ä—ã–∂–æ–∫. */
        #mob-pause { position: absolute; top: 15px; right: 15px; width: 50px; height: 50px; border-radius: 5px; font-size: 12px; pointer-events: auto; background: rgba(255,255,255,0.2); border: 2px solid white; color: white;}
        #mob-editor-controls { position: absolute; bottom: 20px; left: 0; width: 100%; display: flex; justify-content: center; gap: 30px; pointer-events: none; }
        #mob-editor-controls button { pointer-events: auto; width: 60px; height: 60px; font-size: 24px; background: rgba(0,0,0,0.5); color: white; border: 2px solid white; border-radius: 50%; }

        /* Cheat Menu */
        #cheatMenu { background: rgba(0, 20, 0, 0.98); font-family: 'VT323', monospace; color: #0f0; }
        .cheat-box { border: 1px solid #0f0; padding: 20px; width: 70%; display: flex; flex-direction: column; gap: 8px; }
        .cheat-row { display: flex; justify-content: space-between; font-size: 22px; border-bottom: 1px solid #004400; }
        .cheat-toggle { cursor: pointer; color: #555; font-weight: bold; }
        .cheat-toggle.on { color: #0f0; text-shadow: 0 0 5px #0f0; }

        .diff-Easy { color: #2ecc71; }
        .diff-Normal { color: #f1c40f; }
        .diff-Hard { color: #e67e22; }
        .diff-Insane { color: #ff0055; text-shadow: 0 0 5px #ff0055; }

    </style>
</head>
<body>

<audio id="bgMusic" loop></audio>

<div id="game-wrapper">
    <canvas id="gameCanvas" width="800" height="450"></canvas>
    
    <div id="mainMenu" class="overlay">
        <h1>GEOMETRY DREVD 2.1</h1>
        
        <div class="stats-bar">
            <span>‚≠ê <span id="star-count">0</span></span>
            <span>üü° <span id="coin-count">0</span></span>
        </div>

        <div id="level-list" class="level-grid"></div>
        <div style="display:flex; flex-wrap: wrap; justify-content: center;">
            <button class="btn-garage" onclick="openGarage()">üé® –ì–ê–†–ê–ñ</button>
            <button class="btn-achieve" onclick="openAchievements()">üèÜ –î–û–°–¢–ò–ñ–ï–ù–ò–Ø</button>
            <button class="btn-menu" onclick="openSlotsMenu(false)">üõ† –†–ï–î–ê–ö–¢–û–†</button>
            <button class="btn-menu" onclick="openSettings()">‚öô –ù–ê–°–¢–†–û–ô–ö–ò</button>
        </div>
        
        <button id="btn-auth" onclick="handleAuth()">üë§ LOG IN</button>
        <button id="btn-fullscreen" onclick="toggleFullScreen()">‚õ∂</button>
        <button class="btn-secret" onclick="openPasswordMenu()">üîí</button>
    </div>

    <div id="accountMenu" class="overlay hidden">
        <h1>LOGIN</h1>
        <div class="garage-container">
            <input type="text" id="accName" class="pass-input" placeholder="USERNAME">
            <input type="password" id="accPass" class="pass-input" placeholder="PASSWORD">
            <div id="accMsg" style="height:20px; color:red; font-size:12px;"></div>
        </div>
        <div style="display:flex;">
            <button class="btn-menu" onclick="loginAccount()">ENTER</button>
            <button class="btn-menu" onclick="closeAccountMenu()">CANCEL</button>
        </div>
    </div>

    <div id="pinMenu" class="overlay hidden">
        <h1>SECURITY</h1>
        <div class="garage-container">
            <p style="color:#0ff">PIN CODE:</p>
            <input type="text" id="pinInput" class="pass-input" maxlength="4">
            <div id="pinMsg" style="height:20px; color:red; font-size:12px;"></div>
        </div>
        <div style="display:flex;">
            <button class="btn-menu" onclick="checkPin()">OK</button>
            <button class="btn-menu" onclick="closePinMenu()">CANCEL</button>
        </div>
    </div>

    <div id="cheatMenu" class="overlay hidden">
        <h1>HACKER PANEL</h1>
        <div class="cheat-box">
            <div class="cheat-row"><span>GOD MODE</span><span id="cheat-god" class="cheat-toggle" onclick="toggleCheat('god')">[OFF]</span></div>
            <div class="cheat-row"><span>SPEED HACK</span><span id="cheat-speed" class="cheat-toggle" onclick="toggleCheat('speed')">[OFF]</span></div>
            <div class="cheat-row"><span>HITBOXES</span><span id="cheat-hitbox" class="cheat-toggle" onclick="toggleCheat('hitbox')">[OFF]</span></div>
            <div class="cheat-row"><span>RAINBOW</span><span id="cheat-rainbow" class="cheat-toggle" onclick="toggleCheat('rainbow')">[OFF]</span></div>
            <div class="cheat-row" style="margin-top:10px; font-size:18px; color:#aaa; cursor:pointer;" onclick="unlockAll()">[UNLOCK ALL SKINS]</div>
            <div class="cheat-row" style="font-size:18px; color:#aaa; cursor:pointer;" onclick="completeAllLevels()">[COMPLETE LEVELS]</div>
        </div>
        <button class="btn-menu" onclick="closeCheatMenu()" style="border-color:#0f0; color:#0f0; margin-top:20px;">DISCONNECT</button>
    </div>

    <div id="passwordMenu" class="overlay hidden">
        <h1>LOGIN</h1>
        <input type="text" id="passInput" class="pass-input" placeholder="PASSWORD">
        <div id="passError" style="height:20px; color:red;"></div>
        <div style="margin-top:10px;">
            <button class="btn-menu" onclick="checkPassword()">OK</button>
            <button class="btn-menu" onclick="closePasswordMenu()">BACK</button>
        </div>
    </div>

    <div id="achieveMenu" class="overlay hidden">
        <h2>ACHIEVEMENTS</h2>
        <div class="level-grid" id="ach-list" style="display:block;"></div>
        <button class="btn-menu" onclick="closeAchievements()">BACK</button>
    </div>

    <div id="settingsMenu" class="overlay hidden">
        <h1>SETTINGS</h1>
        <div class="garage-container">
            <button id="ctrl-toggle-btn" onclick="toggleControls()" style="width:200px;">MODE: PC</button>
        </div>
        <button class="btn-menu" onclick="closeSettings()">BACK</button>
    </div>

    <div id="slotsMenu" class="overlay hidden">
        <h1 id="slots-title">SLOTS</h1>
        <div class="garage-container" id="slots-container"></div>
        <button class="btn-menu" onclick="closeSlotsMenu()">BACK</button>
    </div>

    <div id="garageMenu" class="overlay hidden">
        <h1>GARAGE</h1>
        <div class="garage-container">
            <div style="color:#aaa; text-align:center;">COLOR</div>
            <div class="selection-row" id="color-selector"></div>
            <div style="color:#aaa; text-align:center; margin-top:5px;">ICON</div>
            <div class="selection-row" id="skin-selector"></div>
        </div>
        <button class="btn-menu" onclick="closeGarage()">OK</button>
    </div>

    <div id="editorHUD" class="hidden">
        <div id="editor-ui">
            <button onclick="setTool(1)">‚ñ≤</button>
            <button onclick="setTool(2)">‚ñ†</button>
            <button onclick="setTool(3)">üåÄ</button>
            <button onclick="setTool(4)">‚è©</button>
            <button onclick="setTool(6)">üü°</button>
            <button onclick="saveCustomLevel()" style="background:#afa">üíæ</button>
            <button onclick="exitToMenu()" style="background:#faa">‚úñ</button>
            <div class="info" id="pc-info">PC: LMB/RMB | Mob: Arrows</div>
        </div>
        <div id="mob-editor-controls" class="hidden">
            <button onclick="moveCam(-1)">‚Üê</button>
            <button onclick="moveCam(1)">‚Üí</button>
        </div>
    </div>
    
    <div id="mobile-play-overlay" class="hidden" onmousedown="handleInput(true)" onmouseup="handleInput(false)" ontouchstart="handleInput(true)" ontouchend="handleInput(false)">
        <button id="mob-pause" onmousedown="event.stopPropagation(); exitToMenu();" ontouchstart="event.stopPropagation(); exitToMenu();">MENU</button>
    </div>

    <div id="endMenu" class="overlay hidden">
        <h1 id="death-msg">CRASHED</h1>
        <div style="display:flex;">
            <button class="btn-menu" onclick="restartLevel()">RETRY</button>
            <button class="btn-menu" onclick="exitToMenu()">MENU</button>
        </div>
    </div>
</div>

<script>
    // --- CORE SETUP ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // Force fixed internal resolution for consistency
    const GAME_WIDTH = 800;
    const GAME_HEIGHT = 450;
    canvas.width = GAME_WIDTH;
    canvas.height = GAME_HEIGHT;

    const bgMusic = document.getElementById('bgMusic');

    // UI Refs
    const mainMenu = document.getElementById('mainMenu');
    const garageMenu = document.getElementById('garageMenu');
    const achieveMenu = document.getElementById('achieveMenu');
    const settingsMenu = document.getElementById('settingsMenu');
    const slotsMenu = document.getElementById('slotsMenu');
    const endMenu = document.getElementById('endMenu');
    const editorHUD = document.getElementById('editorHUD');
    const levelList = document.getElementById('level-list');
    const deathMsg = document.getElementById('death-msg');
    const cheatMenu = document.getElementById('cheatMenu');
    const passwordMenu = document.getElementById('passwordMenu');
    const accountMenu = document.getElementById('accountMenu');
    const pinMenu = document.getElementById('pinMenu');
    
    const starCountEl = document.getElementById('star-count');
    const coinCountEl = document.getElementById('coin-count');
    const btnAuth = document.getElementById('btn-auth');
    const ctrlToggleBtn = document.getElementById('ctrl-toggle-btn');
    const mobPlayOverlay = document.getElementById('mobile-play-overlay'); // –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Å—ã–ª–∫–∞
    const mobEditorControls = document.getElementById('mob-editor-controls'); // –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Å—ã–ª–∫–∞


    // --- GAME DATA ---
    const COLORS = ['#00e676', '#ffeb3b', '#2979ff', '#ff1744', '#d500f9', '#00e5ff', '#ffffff', '#ff9900', '#8800ff', '#ff0088', '#00ffaa', '#aaaaaa'];
    const SKINS = [
        {id:0, name:"Box", unlock:"Free"},
        {id:1, name:"Creeper", unlock:"Collect 3 Coins"},
        {id:2, name:"Pro", unlock:"Get 5 Stars"},
        {id:3, name:"Smile", unlock:"Beat Level 1"}
    ];

    let userSettings = { 
        color: COLORS[0], skin: 0, controls: 'PC', stars: 0, coins: 0, 
        unlockedSkins: [0], completedLevels: [], isLoggedIn: false 
    };

    // --- SAVE SYSTEM ---
    function loadUserData() {
        const saved = localStorage.getItem('drevd_user_v2');
        if(saved) userSettings = Object.assign(userSettings, JSON.parse(saved));
        updateStatsUI();
        updateControlsUI();
        updateAuthButton();
    }
    function saveUserData() { localStorage.setItem('drevd_user_v2', JSON.stringify(userSettings)); updateStatsUI(); }
    function updateStatsUI() { starCountEl.innerText = userSettings.stars; coinCountEl.innerText = userSettings.coins; }
    
    // --- FULLSCREEN ---
    function toggleFullScreen() {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{});
        else if (document.exitFullscreen) document.exitFullscreen();
    }

    // --- AUTHENTICATION ---
    function handleAuth() { if(userSettings.isLoggedIn) logoutAccount(); else openMenu('accountMenu'); }
    function openMenu(id) { document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
    function closeAccountMenu() { accountMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }
    
    function loginAccount() {
        const name = document.getElementById('accName').value;
        const pass = document.getElementById('accPass').value;
        const msg = document.getElementById('accMsg');
        
        if(name === 'Andrevd' && pass === 'AndrevdSecret') {
            userSettings.stars = 99999999; userSettings.coins = 99999999; userSettings.isLoggedIn = true;
            updateStatsUI(); updateAuthButton(); alert("WELCOME CREATOR"); closeAccountMenu();
        } 
        else if (name === 'AndrevdAndArtzz' && pass === 'AndrevdAndArtzzTop') {
            accountMenu.classList.add('hidden'); pinMenu.classList.remove('hidden');
            document.getElementById('pinInput').value = '';
        } 
        else { msg.innerText = "INVALID CREDENTIALS"; }
    }

    function checkPin() {
        if(document.getElementById('pinInput').value === '2526') {
            userSettings.stars = "9999999999999999"; userSettings.coins = "9999999999999999"; userSettings.isLoggedIn = true;
            userSettings.unlockedSkins = [0,1,2,3]; saveUserData(); updateAuthButton();
            pinMenu.classList.add('hidden'); mainMenu.classList.remove('hidden');
            alert("GOD ACCOUNT ACTIVATED");
        } else { document.getElementById('pinMsg').innerText = "WRONG PIN"; }
    }
    function closePinMenu() { pinMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }

    function logoutAccount() {
        if(confirm("LOG OUT? This will reset progress.")) {
            localStorage.removeItem('drevd_user_v2'); location.reload();
        }
    }
    function updateAuthButton() {
        btnAuth.innerText = userSettings.isLoggedIn ? "üë§ LOG OUT" : "üë§ LOG IN";
        btnAuth.style.color = userSettings.isLoggedIn ? "red" : "#00e5ff";
        btnAuth.style.borderColor = userSettings.isLoggedIn ? "red" : "#00e5ff";
    }

    // --- CHEATS ---
    let cheats = { god: false, speed: false, hitbox: false, rainbow: false };
    function openPasswordMenu() { openMenu('passwordMenu'); document.getElementById('passInput').value=''; document.getElementById('passError').innerText=''; }
    function closePasswordMenu() { passwordMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }
    function checkPassword() {
        if(document.getElementById('passInput').value === "Andrevdtop") { openMenu('cheatMenu'); }
        else { document.getElementById('passError').innerText="WRONG PASSWORD"; }
    }
    function toggleCheat(c) {
        cheats[c] = !cheats[c];
        const el = document.getElementById(`cheat-${c}`);
        el.innerText = cheats[c] ? "[ON]" : "[OFF]"; el.classList.toggle('on', cheats[c]);
    }
    function unlockAll() { userSettings.unlockedSkins=[0,1,2,3]; saveUserData(); alert("Unlocked!"); }
    function completeAllLevels() { LEVELS.forEach((l,i) => { if(!userSettings.completedLevels.includes(i)) { userSettings.completedLevels.push(i); userSettings.stars+=l.stars; } }); saveUserData(); alert("Levels Completed!"); initMenu(); }
    function closeCheatMenu() { cheatMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }

    // --- ACHIEVEMENTS ---
    const ACHIEVEMENTS = [
        {id: "win1", name: "First Steps", desc: "Pass Level 1", check: ()=>userSettings.completedLevels.includes(0), reward: "Skin: Smile", rId: 3},
        {id: "rich", name: "Rich", desc: "Collect 3 Coins", check: ()=>userSettings.coins>=3, reward: "Skin: Creeper", rId: 1},
        {id: "pro", name: "Star Master", desc: "Get 5 Stars", check: ()=>userSettings.stars>=5, reward: "Skin: Pro", rId: 2}
    ];
    function checkAchievements() {
        let changed = false;
        ACHIEVEMENTS.forEach(ach => {
            if(ach.check() && !userSettings.unlockedSkins.includes(ach.rId)) {
                userSettings.unlockedSkins.push(ach.rId); alert(`ACHIEVEMENT: ${ach.name}`); changed=true;
            }
        });
        if(changed) saveUserData();
    }
    function openAchievements() {
        openMenu('achieveMenu');
        const list = document.getElementById('ach-list'); list.innerHTML = '';
        ACHIEVEMENTS.forEach(ach => {
            let u = userSettings.unlockedSkins.includes(ach.rId);
            let item = document.createElement('div');
            item.style = `padding:10px; border:1px solid #444; margin-bottom:5px; background:${u?'#1a331a':'#222'}; border-color:${u?'#0f0':'#444'}`;
            item.innerHTML = `<div><b>${ach.name}</b></div><div style="font-size:12px;color:#aaa">${ach.desc}</div><div style="font-size:10px;color:${u?'#0f0':'#777'}">${ach.reward}</div>`;
            list.appendChild(item);
        });
    }
    function closeAchievements() { achieveMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }

    // --- LEVELS ---
    // !!! –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ 'gspd.mp3' –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –∏–ª–∏ –Ω–∞–¥–µ–∂–Ω—É—é —Å—Å—ã–ª–∫—É.
    const MUSIC_TRACKS = {
        techno: "gspd.mp3", 
        fast: "https://commondatastorage.googleapis.com/codeskulptor-demos/riceracer_assets/music/race1.ogg",
        epic: "https://commondatastorage.googleapis.com/codeskulptor-assets/week7-brrring.m4a",
        demon: "https://commondatastorage.googleapis.com/codeskulptor-demos/pyman_assets/eaten.ogg"
    };
    const LEVELS = [
        { name: "Genesis", diff: "Easy", stars: 3, track: "techno", data: [{x:5,y:0,t:2},{x:6,y:0,t:2},{x:7,y:0,t:2},{x:10,y:2,t:6},{x:12,y:0,t:1},{x:16,y:0,t:2},{x:17,y:1,t:2},{x:22,y:0,t:1},{x:26,y:0,t:4},{x:32,y:0,t:2},{x:32,y:1,t:2},{x:38,y:0,t:1},{x:45,y:0,t:5},{x:50,y:0,t:2},{x:50,y:1,t:1},{x:55,y:0,t:1},{x:56,y:0,t:1}] },
        { name: "Coin Rush", diff: "Normal", stars: 5, track: "epic", data: [{x:5,y:0,t:2},{x:8,y:0,t:3},{x:10,y:3,t:6},{x:15,y:4,t:2},{x:18,y:1,t:6},{x:20,y:2,t:2},{x:25,y:5,t:2},{x:30,y:1,t:2},{x:32,y:3,t:6},{x:35,y:4,t:2},{x:40,y:0,t:3},{x:45,y:0,t:1},{x:48,y:0,t:1},{x:52,y:0,t:2},{x:52,y:1,t:1}] },
        { name: "Speed Run", diff: "Hard", stars: 8, track: "fast", data: [{x:3,y:0,t:4},{x:8,y:0,t:1},{x:14,y:0,t:2},{x:18,y:0,t:1},{x:24,y:1,t:2},{x:30,y:0,t:3},{x:35,y:5,t:2},{x:40,y:0,t:2},{x:45,y:5,t:2},{x:50,y:0,t:3},{x:55,y:0,t:5},{x:60,y:0,t:1},{x:61,y:0,t:1},{x:62,y:0,t:1}] },
        { name: "Demon Hell", diff: "Insane", stars: 14, track: "demon", data: [{x:5,y:0,t:4},{x:8,y:0,t:1},{x:9,y:0,t:1},{x:10,y:0,t:1},{x:12,y:2,t:6},{x:15,y:0,t:2},{x:15,y:1,t:1},{x:20,y:0,t:3},{x:25,y:1,t:2},{x:25,y:4,t:2},{x:30,y:0,t:2},{x:30,y:5,t:2},{x:32,y:3,t:6},{x:38,y:0,t:3},{x:42,y:0,t:1},{x:43,y:0,t:1},{x:44,y:0,t:1},{x:50,y:0,t:2},{x:50,y:1,t:2},{x:50,y:2,t:6},{x:55,y:0,t:1},{x:56,y:0,t:1}] }
    ];

    // --- GAME ENGINE ---
    const BLOCK_SIZE = 40; const GRAVITY = 0.65; const JUMP_FORCE = -10.8; const SHIP_GRAVITY = 0.35; const SHIP_LIFT = -0.45;
    let animationId = null, gameState = 'MENU', currentLevelData = [], currentLevelIndex = -1, currentSlotId = 0, cameraX = 0, currentSpeed = 6.0, particles = [], isHolding = false, editorScrollX = 0, selectedTool = 1, sessionCoins = 0;
    let player = { x: 0, y: 0, dy: 0, angle: 0, width: 30, height: 30, mode: 'CUBE', onGround: false, isDead: false, color: '#00e676', skinId: 0, endX: 0 };
    let lastTime = 0; // For delta time calculation

    // Optimized Audio
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function sfx(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume().catch(e => console.error("AudioContext resume error:", e));
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        if(type==='jump') { osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(300, now+0.1); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.1); }
        else if(type==='coin') { osc.type='sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(1200, now+0.1); gain.gain.setValueAtTime(0.1, now); }
        else if(type==='crash') { osc.type='sawtooth'; osc.frequency.setValueAtTime(100, now); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.3); }
        osc.start(now); osc.stop(now+(type==='crash'?0.3:0.1));
    }

    // =================================================================
    // >>> –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ò –£–õ–£–ß–®–ï–ù–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –í–í–û–î–ê (INPUT HANDLERS)
    // =================================================================
    function handleInput(down) {
        // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–≤–µ—Ä–ª–µ–µ–º –∏ canvas –¥–ª—è —Ç–∞–ø–æ–≤/–∫–ª–∏–∫–æ–≤
        if(gameState === 'PLAY') isHolding = down;
        // –í EDITOR —Ä–µ–∂–∏–º–µ –≤–≤–æ–¥ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ listeners –Ω–∏–∂–µ.
    }

    // --- KEYBOARD INPUT ---
    document.addEventListener('keydown', e => {
        if(gameState === 'PLAY') {
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä—ã–∂–∫–æ–º/–ø–æ–ª–µ—Ç–æ–º: –ü—Ä–æ–±–µ–ª, –°—Ç—Ä–µ–ª–∫–∞ –í–≤–µ—Ä—Ö, W
            if (e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') {
                isHolding = true;
                e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —Å–∫—Ä–æ–ª–ª–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                if (player.onGround && player.mode === 'CUBE') sfx('jump'); // –ó–≤—É–∫ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∑–µ–º–ª–µ
            }
            // –ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫: R
            if (e.code === 'KeyR' && player.isDead) {
                restartLevel();
            }
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ (PC)
        if (gameState === 'EDITOR' && userSettings.controls === 'PC') {
             if (e.code === 'ArrowLeft' || e.code === 'KeyA') {
                moveCam(-1); 
                e.preventDefault();
            }
             if (e.code === 'ArrowRight' || e.code === 'KeyD') {
                moveCam(1);
                e.preventDefault();
            }
        }
    });

    document.addEventListener('keyup', e => {
        if(gameState === 'PLAY') {
            // –û—Ç–ø—É—Å–∫–∞–Ω–∏–µ –ø—Ä—ã–∂–∫–∞/–ø–æ–ª–µ—Ç–∞
            if (e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') {
                isHolding = false;
            }
        }
    });

    // --- MOUSE/TOUCH INPUT (PC Mode) ---
    // –í —Ä–µ–∂–∏–º–µ PC –∫–ª–∏–∫ –ø–æ canvas —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä—ã–∂–∫–æ–º
    canvas.addEventListener('mousedown', e => { 
        if(gameState === 'PLAY' && userSettings.controls === 'PC') handleInput(true);
    });
    canvas.addEventListener('mouseup', e => { 
        if(gameState === 'PLAY' && userSettings.controls === 'PC') handleInput(false);
    });
    
    // =================================================================
    // >>> –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø UI
    // =================================================================
    
    function toggleControls() {
        userSettings.controls = userSettings.controls === 'PC' ? 'MOBILE' : 'PC';
        saveUserData();
        updateControlsUI();
    }
    
    function updateControlsUI() {
        ctrlToggleBtn.innerText = `MODE: ${userSettings.controls}`;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è PC
        document.getElementById('pc-info').style.display = userSettings.controls === 'PC' ? 'block' : 'none';

        // –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–≤–µ—Ä–ª–µ–µ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
        if (gameState === 'PLAY') {
             mobPlayOverlay.classList.toggle('hidden', userSettings.controls === 'PC');
             mobEditorControls.classList.add('hidden');
        } else if (gameState === 'EDITOR') {
             mobPlayOverlay.classList.add('hidden');
             mobEditorControls.classList.toggle('hidden', userSettings.controls === 'PC');
        } else {
             // –í –º–µ–Ω—é –≤—Å–µ —Å–∫—Ä—ã—Ç–æ
             mobPlayOverlay.classList.add('hidden');
             mobEditorControls.classList.add('hidden');
        }
    }
    
    function startLevel(index) {
        // ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ startLevel) ...
        currentLevelIndex = index;
        currentLevelData = (index < LEVELS.length) ? LEVELS[index].data : [];
        // ... (—Å–±—Ä–æ—Å player –∏ —Ç.–¥.) ...
        player = { x: 0, y: 0, dy: 0, angle: 0, width: 30, height: 30, mode: 'CUBE', onGround: false, isDead: false, color: userSettings.color, skinId: userSettings.skin, endX: 0 };
        cameraX = 0; currentSpeed = 6.0; sessionCoins = 0;
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ–≤–µ—Ä–ª–µ–∏
        document.querySelectorAll('.overlay').forEach(el=>el.classList.add('hidden'));
        document.getElementById('editorHUD').classList.add('hidden');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–±–∏–ª—å–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if(userSettings.controls === 'MOBILE') {
            mobPlayOverlay.classList.remove('hidden');
        }

        gameState = 'PLAY';
        if(animationId) cancelAnimationFrame(animationId);
        lastTime = performance.now();
        loop();

        // –ó–∞–ø—É—Å–∫ –º—É–∑—ã–∫–∏
        const track = (index < LEVELS.length) ? LEVELS[index].track : 'techno';
        bgMusic.src = MUSIC_TRACKS[track] || MUSIC_TRACKS['techno'];
        bgMusic.play().catch(e => console.warn("Music auto-play failed. User interaction needed."));
    }
    
    function exitToMenu() {
        if(animationId) cancelAnimationFrame(animationId);
        gameState = 'MENU';
        bgMusic.pause();
        
        document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
        document.getElementById('editorHUD').classList.add('hidden');
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–±–∏–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –º–µ–Ω—é
        mobPlayOverlay.classList.add('hidden');
        mobEditorControls.classList.add('hidden');

        mainMenu.classList.remove('hidden');
        initMenu();
    }
    
    // =================================================================
    // >>> –õ–û–ì–ò–ö–ê –†–ï–î–ê–ö–¢–û–†–ê (EDITOR)
    // =================================================================
    
    // Editor functions
    function openEditor(slotId) {
        currentSlotId = slotId;
        const saved = localStorage.getItem(`drevd_custom_${currentSlotId}`);
        currentLevelData = saved ? JSON.parse(saved) : [];
        editorScrollX = 0;
        
        document.querySelectorAll('.overlay').forEach(el=>el.classList.add('hidden'));
        editorHUD.classList.remove('hidden');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –º–æ–±–∏–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        mobPlayOverlay.classList.add('hidden'); 
        mobEditorControls.classList.toggle('hidden', userSettings.controls === 'PC');
        
        gameState = 'EDITOR';
        if(animationId) cancelAnimationFrame(animationId);
        lastTime = performance.now();
        loop();
    }
    
    // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞, –∫–∞–∫ —É –≤–∞—Å) ...
    // Editor Mouse Logic
    canvas.addEventListener('click', e => {
        if(gameState !== 'EDITOR' || userSettings.controls !== 'PC') return;
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const canvasX = (e.clientX - rect.left) * scaleX;
        const canvasY = (e.clientY - rect.top) * scaleY;
        const gridX = Math.floor((canvasX + editorScrollX) / BLOCK_SIZE);
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞: y=0 - –Ω–∏–∂–Ω–∏–π —Ä—è–¥
        const gridY = Math.floor((GAME_HEIGHT - canvasY) / BLOCK_SIZE); 

        if(e.button === 0) { // Left Click (Add)
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç (–¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ç–∏–ø–æ–≤)
            const exists = currentLevelData.some(o => o.x === gridX && o.y === gridY && o.t === selectedTool);
            if (!exists) {
                 currentLevelData.push({ x: gridX, y: gridY, t: selectedTool });
            }
        } 
        // –õ–æ–≥–∏–∫–∞ Right Click (Remove) –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (contextmenu)
        drawEditor();
    });
    
    canvas.addEventListener('contextmenu', e => {
        if(gameState === 'EDITOR' && userSettings.controls === 'PC') {
            e.preventDefault(); // Prevent context menu on right click
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const canvasX = (e.clientX - rect.left) * scaleX;
            const canvasY = (e.clientY - rect.top) * scaleY;
            const gridX = Math.floor((canvasX + editorScrollX) / BLOCK_SIZE);
            const gridY = Math.floor((GAME_HEIGHT - canvasY) / BLOCK_SIZE);

            // Right Click (Remove) - –£–¥–∞–ª—è–µ—Ç –æ–±—ä–µ–∫—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –≤ —ç—Ç–æ–π —è—á–µ–π–∫–µ
            let indexToRemove = -1;
            for(let i = 0; i < currentLevelData.length; i++) {
                const o = currentLevelData[i];
                // –£–¥–∞–ª—è–µ–º –æ–±—ä–µ–∫—Ç —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–µ–π—á–∞—Å –≤—ã–±—Ä–∞–Ω
                if(o.x === gridX && o.y === gridY && o.t === selectedTool) { 
                    indexToRemove = i;
                    break;
                }
            }
            if(indexToRemove !== -1) currentLevelData.splice(indexToRemove, 1);
            drawEditor();
        }
    });

    // ... (–≤–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥, –≤–∫–ª—é—á–∞—è drawAvatar, drawObject, collision, update, loop –∏ init) ...
    
    // Drawing functions
    function drawAvatar(ctx, x, y, size, skinId, color, angle, mode) {
        // ... (–≤–∞—à –∫–æ–¥) ...
    }
    
    function drawObject(obj, camX, isEditor=false) {
        // ... (–≤–∞—à –∫–æ–¥) ...
    }
    
    // --- Collision Detection and Update ---
    function checkCollision(player, obj, camX) {
        // ... (–≤–∞—à –∫–æ–¥) ...
    }
    
    function update(deltaTime) {
        // ... (–≤–∞—à –∫–æ–¥) ...
    }
    
    function draw() {
        // ... (–≤–∞—à –∫–æ–¥) ...
    }
    
    function drawEditor() {
        // ... (–≤–∞—à –∫–æ–¥) ...
    }

    function loop(time) {
        // ... (–≤–∞—à –∫–æ–¥) ...
    }
    
    // --- UTILITIES ---
    function restartLevel() {
        // ... (–≤–∞—à –∫–æ–¥) ...
    }
    
    function openSlotsMenu(isPlay) {
        // ... (–≤–∞—à –∫–æ–¥) ...
    }
    
    function openGarage() {
        // ... (–≤–∞—à –∫–æ–¥) ...
    }
    
    function closeGarage() {
        // ... (–≤–∞—à –∫–æ–¥) ...
    }
    
    function openSettings() {
        // ... (–≤–∞—à –∫–æ–¥) ...
    }
    
    function closeSettings() {
        // ... (–≤–∞—à –∫–æ–¥) ...
    }
    
    function initMenu() {
        // ... (–≤–∞—à –∫–æ–¥) ...
    }

    // --- INITIALIZATION ---
    loadUserData();
    initMenu();
</script>

</body>
</html>
